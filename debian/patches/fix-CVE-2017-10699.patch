Description: check visible size when creating buffer
 avcodec 2.2.x, as used in VideoLAN VLC media player 2.2.7-x before
 2017-06-29, allows out-of-bounds heap memory write due to calling memcpy()
 with a wrong size, leading to a denial of service (application crash) or
 possibly code execution.
 .
 This fixes CVE-2017-10699.
Author: Francois Cartegnie <fcvlcdev@free.fr>
Origin: upstream
Applied-Upstream: 6cc73bcad19da2cd2e95671173f2e0d203a57e9b, a38a85db58c569cc592d9380cc07096757ef3d49
Last-Update: 2017-07-07
--- a/modules/codec/avcodec/video.c
+++ b/modules/codec/avcodec/video.c
@@ -137,9 +137,11 @@ static inline picture_t *ffmpeg_NewPictB
     }
 
 
-    if( width == 0 || height == 0 || width > 8192 || height > 8192 )
+    if( width == 0 || height == 0 || width > 8192 || height > 8192 ||
+        width < p_context->width || height < p_context->height )
     {
-        msg_Err( p_dec, "Invalid frame size %dx%d.", width, height );
+        msg_Err( p_dec, "Invalid frame size %dx%d. vsz %dx%d",
+                 width, height, p_context->width, p_context->height );
         return NULL; /* invalid display size */
     }
     p_dec->fmt_out.video.i_width = width;
--- a/src/input/decoder.c
+++ b/src/input/decoder.c
@@ -2059,7 +2059,9 @@ static picture_t *vout_new_buffer( decod
         vout_thread_t *p_vout;
 
         if( !p_dec->fmt_out.video.i_width ||
-            !p_dec->fmt_out.video.i_height )
+            !p_dec->fmt_out.video.i_height ||
+            p_dec->fmt_out.video.i_width < p_dec->fmt_out.video.i_visible_width ||
+            p_dec->fmt_out.video.i_height < p_dec->fmt_out.video.i_visible_height )
         {
             /* Can't create a new vout without display size */
             return NULL;
