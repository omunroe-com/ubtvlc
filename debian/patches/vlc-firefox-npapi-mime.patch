From a9aa594f5101f550e03c31da899c6c1968fb1e00 Mon Sep 17 00:00:00 2001
From: Rafaël Carré <funman@videolan.org>
Date: Sun, 13 Nov 2011 15:14:07 -0500
Subject: [PATCH] Handle NPP_GetMIMEDescription having different return types

---
 configure.ac             |   20 ++++++++++++++++++++
 projects/mozilla/support/npunix.cpp |    7 ++++---
 projects/mozilla/support/npwin.cpp  |    6 +++++-
 projects/mozilla/vlcshell.cpp       |    7 ++++++-
 projects/mozilla/vlcshell.h         |    6 +++++-
 5 files changed, 40 insertions(+), 6 deletions(-)

Index: vlc/configure.ac
===================================================================
--- vlc.orig/configure.ac	2011-11-16 11:05:12.000000000 -0500
+++ vlc/configure.ac	2011-11-16 11:35:14.661408112 -0500
@@ -4595,6 +4595,25 @@
         if test "${MOZILLA_REQUIRED_HEADERS}" = "0"; then
             AC_MSG_ERROR([Please install the Firefox development tools; plugin/npapi.h and/or plugin/npruntime.h were not found.])
         fi
+AC_MSG_CHECKING([if NPP_GetMIMEDescription() returns const])
+AC_COMPILE_IFELSE([AC_LANG_SOURCE([
+   #ifdef WIN32
+   # define XP_WIN 1
+   #else
+  # ifdef __APPLE__
+   #  define XP_MACOSX 1
+   # endif
+   # define XP_UNIX 1
+   #endif
+  #include <npapi.h>
+  const char *NPP_GetMIMEDescription(void);
+])],[
+  AC_MSG_RESULT(yes)
+  AC_DEFINE(NPP_GET_MIME_CONST, [const], [Wether NPP_GetMIMEDescription returns const])
+],[
+  AC_MSG_RESULT(no)
+  AC_DEFINE(NPP_GET_MIME_CONST, [], [Wether NPP_GetMIMEDescription returns const])
+])
         MOZILLA_REQUIRED_HEADERS=
         mozilla=:
         AS_IF([ test "${SYS}" != "mingw32" -a "${SYS}" != "mingwce"],[
@@ -4660,6 +4679,25 @@
       then
         AC_MSG_ERROR([Please install the Mozilla development tools, required headers were not found.])
       fi
+AC_MSG_CHECKING([if NPP_GetMIMEDescription() returns const])
+AC_COMPILE_IFELSE([AC_LANG_SOURCE([
+   #ifdef WIN32
+   # define XP_WIN 1
+   #else
+  # ifdef __APPLE__
+   #  define XP_MACOSX 1
+   # endif
+   # define XP_UNIX 1
+   #endif
+  #include <npapi.h>
+  const char *NPP_GetMIMEDescription(void);
+])],[
+  AC_MSG_RESULT(yes)
+  AC_DEFINE(NPP_GET_MIME_CONST, [const], [Wether NPP_GetMIMEDescription returns const])
+],[
+  AC_MSG_RESULT(no)
+  AC_DEFINE(NPP_GET_MIME_CONST, [], [Wether NPP_GetMIMEDescription returns const])
+])
       MOZILLA_REQUIRED_HEADERS=
       CPPFLAGS="${CPPFLAGS_save}"
       MOZILLA_SDK_PATH="`${MOZILLA_CONFIG} --prefix`"
Index: vlc/projects/mozilla/support/npunix.cpp
===================================================================
--- vlc.orig/projects/mozilla/support/npunix.cpp	2011-11-16 11:05:06.000000000 -0500
+++ vlc/projects/mozilla/support/npunix.cpp	2011-11-16 11:32:38.541415073 -0500
@@ -43,7 +43,9 @@
  *----------------------------------------------------------------------
  */
 
-#include "config.h"
+#ifdef HAVE_CONFIG_H
+# include "config.h"
+#endif
 
 #define XP_UNIX 1
 
@@ -767,7 +769,7 @@
  *  - Netscape uses the return value to identify when an object instance
  *    of this plugin should be created.
  */
-char *
+NPP_GET_MIME_CONST char *
 NP_GetMIMEDescription(void)
 {
     return NPP_GetMIMEDescription();
Index: vlc/projects/mozilla/support/npwin.cpp
===================================================================
--- vlc.orig/projects/mozilla/support/npwin.cpp	2011-11-16 11:05:06.000000000 -0500
+++ vlc/projects/mozilla/support/npwin.cpp	2011-11-16 11:33:18.369413299 -0500
@@ -26,10 +26,12 @@
  *
  */
 
-#include "config.h"
-
 //#define OJI 1
 
+#ifdef HAVE_CONFIG_H
+# include "config.h"
+#endif
+
 #include "../vlcplugin.h"
 
 #ifndef _NPAPI_H_
@@ -184,7 +186,7 @@
     return NPERR_NO_ERROR;
 }
 
-char * NP_GetMIMEDescription()
+NPP_GET_MIME_CONST char * NP_GetMIMEDescription()
 {
   return NPP_GetMIMEDescription();
 }
Index: vlc/projects/mozilla/vlcshell.cpp
===================================================================
--- vlc.orig/projects/mozilla/vlcshell.cpp	2011-11-16 11:05:06.000000000 -0500
+++ vlc/projects/mozilla/vlcshell.cpp	2011-11-16 11:34:09.081411037 -0500
@@ -25,7 +25,9 @@
 /*****************************************************************************
  * Preamble
  *****************************************************************************/
-#include "config.h"
+#ifdef HAVE_CONFIG_H
+# include "config.h"
+#endif
 
 #include <stdio.h>
 #include <string.h>
@@ -71,7 +73,7 @@
 /******************************************************************************
  * UNIX-only API calls
  *****************************************************************************/
-char * NPP_GetMIMEDescription( void )
+NPP_GET_MIME_CONST char * NPP_GetMIMEDescription( void )
 {
     static char mimetype[] = PLUGIN_MIMETYPES;
     return mimetype;
Index: vlc/projects/mozilla/vlcshell.h
===================================================================
--- vlc.orig/projects/mozilla/vlcshell.h	2011-11-16 11:05:06.000000000 -0500
+++ vlc/projects/mozilla/vlcshell.h	2011-11-16 11:34:39.733409670 -0500
@@ -24,7 +24,11 @@
 #ifndef __VLCSHELL_H__
 #define __VLCSHELL_H__
 
-char * NPP_GetMIMEDescription( void );
+#ifdef HAVE_CONFIG_H
+# include "config.h"
+#endif
+
+NPP_GET_MIME_CONST char * NPP_GetMIMEDescription( void );
 
 NPError NPP_Initialize( void );
 
